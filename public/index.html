<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>folio - Your Personal Library</title>
    <meta name="description" content="A modern interface for browsing and managing your Calibre library with Hardcover.app discovery">
    
    <!-- PWA -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#f6f7fa">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Manrope', 'system-ui', '-apple-system', 'sans-serif'],
                        display: ['Spectral', 'Georgia', 'serif'],
                        logo: ['Spectral', 'Georgia', 'serif'],
                    },
                    colors: {
                        ink: {
                            50: '#fafafa',   // Light background
                            100: '#ffffff',  // White
                            200: '#f4f4f5',  // Subtle gray
                            300: '#e4e4e7',  // Border gray
                            400: '#a1a1aa',  // Muted text
                            500: '#71717a',  // Secondary text
                            600: '#52525b',  // Medium gray
                            700: '#3f3f46',  // Dark gray
                            800: '#27272a',  // Darker
                            900: '#18181b',  // Almost black
                        }
                    }
                }
            }
        }
    </script>

    <!-- Alpine.js with Intersect plugin -->
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/intersect@3.13.3/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Spectral:wght@400;500;600;700&family=Manrope:wght@400;500;600;700;800&family=Oldenburg&display=swap" rel="stylesheet">

    <!-- Bootstrap Icons (CSS-only, no JS needed) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        [x-cloak] { display: none !important; }

        :root {
            --font-sans: 'Manrope', system-ui, -apple-system, sans-serif;
            --font-display: 'Spectral', Georgia, serif;
            --font-logo: 'Oldenburg', cursive;
        }
        
        * {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation; /* Prevents double-tap zoom and pinch zoom */
        }
        
        /* Prevent pinch zoom - allow scrolling but prevent zoom gestures */
        html, body {
            touch-action: pan-x pan-y;
            -ms-touch-action: pan-x pan-y;
        }

        html {
            font-family: var(--font-sans);
            scroll-behavior: smooth;
            /* Prevent zooming */
            touch-action: pan-x pan-y;
            -ms-touch-action: pan-x pan-y;
            overflow-x: hidden;
        }

        body {
            background: #fafafa; /* Light gray background */
            min-height: 100vh;
            color: #18181b; /* Main text - almost black */
            /* Prevent zooming */
            touch-action: pan-x pan-y;
            -ms-touch-action: pan-x pan-y;
            overflow-x: hidden;
            position: relative;
        }
        
        .font-display {
            font-family: var(--font-display);
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        
        /* Swipeable grid pages for library */
        .library-pages {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            gap: 0;
        }
        .library-pages::-webkit-scrollbar {
            display: none;
        }
        .library-page {
            flex-shrink: 0;
            width: 100%;
            scroll-snap-align: start;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            padding: 0 16px;
        }
        @media (min-width: 640px) {
            .library-page {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        @media (min-width: 768px) {
            .library-page {
                grid-template-columns: repeat(5, 1fr);
            }
        }
        @media (min-width: 1024px) {
            .library-page {
                grid-template-columns: repeat(6, 1fr);
            }
        }
        
        /* Horizontal scroll sections for Hardcover */
        .scroll-section {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            padding: 4px 0 8px 0;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .scroll-section::-webkit-scrollbar {
            display: none;
        }
        .scroll-section > * {
            scroll-snap-align: start;
            flex-shrink: 0;
        }
        
        /* Book card */
        .book-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .book-card:hover {
            transform: translateY(-2px);
        }
        .book-card:active {
            transform: scale(0.98);
        }

        .book-cover {
            aspect-ratio: 2/3;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1), 0 1px 3px rgba(0,0,0,0.05);
            background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
        }
        .book-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Hardcover book card - smaller to emphasize library */
        .hc-book-card {
            width: 100px;
        }
        
        /* Glass effect for modals */
        .glass {
            background: rgba(246, 247, 250, 0.95); /* Background with glass */
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        
        /* Setup wizard */
        .setup-card {
            background: #ffffff; /* Modal background */
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
        }
        
        /* Input styling */
        .input-field {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.2s ease;
            background: #fafbfc;
        }
        .input-field:focus {
            outline: none;
            border-color: #5a4be0;
            background: white;
            box-shadow: 0 0 0 4px rgba(90, 75, 224, 0.1);
        }
        .input-field.error {
            border-color: #ef4444;
            background: #fef2f2;
        }
        .input-field.success {
            border-color: #22c55e;
            background: #f0fdf4;
        }
        
        /* Button styles - Mobile-first with larger touch targets */
        .btn {
            padding: 14px 28px;
            min-width: 44px; /* Minimum touch target size */
            min-height: 44px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px; /* Larger text for mobile */
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
        }
        
        @media (min-width: 640px) {
            .btn {
                padding: 12px 24px;
                font-size: 15px;
            }
        }
        
        /* Icon buttons - ensure width >= height - Mobile-first: minimum 44x44px touch target */
        button[class*="p-2"]:not(.btn),
        button[class*="p-3"]:not(.btn),
        a[class*="p-2"],
        a[class*="p-3"] {
            min-width: 44px;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Ensure all interactive elements have adequate touch targets */
        button, a[role="button"], .clickable {
            min-height: 44px;
            min-width: 44px;
        }
        
        /* Input fields should also be larger on mobile */
        input, textarea, select {
            min-height: 44px;
            font-size: 16px; /* Prevents zoom on iOS */
        }
        .btn-primary {
            background: #18181b;
            color: #ffffff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
        }
        .btn-primary:hover {
            background: #27272a;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.06);
        }
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .btn-secondary {
            background: #ffffff;
            color: #18181b;
            border: 1px solid #e4e4e7;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        .btn-secondary:hover {
            background: #fafafa;
            border-color: #a1a1aa;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }
        .btn-success {
            background: #52525b;
            color: #ffffff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
        }
        .btn-success:hover {
            background: #3f3f46;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.06);
        }
        
        /* Section header - Increased spacing for mobile */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        /* Increased padding between sections for better mobile legibility */
        section {
            margin-bottom: 24px;
            padding-bottom: 16px;
        }
        
        @media (min-width: 640px) {
            section {
                margin-bottom: 32px;
                padding-bottom: 24px;
            }
        }
        .section-title {
            font-family: var(--font-display);
            font-size: 1.25rem;
            font-weight: 600;
            color: #18181b;
        }
        .section-title-large {
            font-family: var(--font-display);
            font-size: 1.75rem;
            font-weight: 700;
            color: #18181b;
        }
        
        /* Rating stars */
        .rating {
            display: flex;
            align-items: center;
            gap: 2px;
        }
        .star {
            width: 14px;
            height: 14px;
            color: #fbbf24;
        }
        .star-empty {
            color: #e5e7eb;
        }
        
        /* Status badge */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 100px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-library {
            background: #dcfce7;
            color: #166534;
        }
        .badge-requested {
            background: #fef3c7;
            color: #92400e;
        }
        
        /* Directory browser */
        .dir-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.15s ease;
        }
        .dir-item:hover {
            background: #f1f5f9;
        }
        .dir-item.calibre {
            background: #ecfdf5;
            border: 2px solid #86efac;
        }
        
        /* Loading spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e5e7eb;
            border-top-color: #0ea5e9;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Skeleton loading */
        .skeleton {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 6px;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Modal overlay */
        .modal-overlay {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
        }
        
        /* Animations */
        .fade-in {
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-up {
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(100%); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Safe area padding */
        .safe-area-bottom {
            padding-bottom: max(16px, env(safe-area-inset-bottom));
        }
        .safe-area-top {
            padding-top: max(8px, env(safe-area-inset-top));
        }
        
        /* Page indicators */
        .page-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #d1d5db;
            transition: all 0.2s ease;
        }
        .page-indicator.active {
            width: 18px;
            border-radius: 3px;
            background: #0ea5e9;
        }
        
        /* Compact header */
        .compact-header {
            height: 48px;
        }

        /* Header scroll shadow effect */
        .header-scrolled {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        /* Divider with text */
        .divider-text {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #64748b;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .divider-text::before,
        .divider-text::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, #e2e8f0 0%, transparent 100%);
        }
        .divider-text::after {
            background: linear-gradient(90deg, transparent 0%, #e2e8f0 100%);
        }
        
        /* Sort select */
        .sort-select {
            padding: 6px 28px 6px 10px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 13px;
            background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E") no-repeat right 8px center;
            appearance: none;
            cursor: pointer;
        }
        .sort-select:focus {
            outline: none;
            border-color: #18181b;
        }

        /* Pill-style navigation toggle */
        /* Modern tab navigation styles */
        .tab-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 0;
            font-size: 15px;
            font-weight: 600;
            border: none;
            background: transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
            position: relative;
        }
        .tab-active {
            color: #18181b;
            border-bottom-color: #18181b;
        }
        .tab-inactive {
            color: #71717a;
        }
        .tab-inactive:hover {
            color: #52525b;
        }

        /* View fade transitions */
        .view-fade-enter {
            animation: viewFadeIn 0.3s ease;
        }
        @keyframes viewFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Badge styles for Requested and Kobo */
        .badge-requested {
            background: #f97316;
            color: #ffffff;
            font-size: 11px;
            font-weight: 700;
            padding: 5px 10px;
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(249, 115, 22, 0.4);
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .badge-kobo {
            background: #10b981;
            color: #ffffff;
            font-size: 11px;
            font-weight: 700;
            padding: 5px 10px;
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
            align-items: center;
            gap: 4px;
        }

        /* Swipe card styles */
        .swipe-card {
            touch-action: none;
            user-select: none;
            cursor: grab;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease;
        }
        .swipe-card:active {
            cursor: grabbing;
            transition: none;
        }
    </style>
</head>
<body x-data="folioApp()" x-init="init()">
    
    <!-- Setup Screen -->
    <div x-show="showSetup" x-cloak class="min-h-screen flex items-center justify-center p-4">
        <div class="setup-card max-w-md w-full mx-auto p-8 fade-in">
            <!-- Logo -->
            <div class="text-center mb-8">
                <h1 class="font-logo text-5xl sm:text-6xl font-bold mb-4" style="color: #D4406F;">folio</h1>
                <p class="text-ink-500 mt-2">Let's get your library set up</p>
        </div>

            <!-- Step Indicator -->
            <div class="flex items-center justify-center gap-2 mb-8 flex-wrap">
                <div class="flex items-center gap-2">
                    <div :class="setupStep >= 1 ? 'bg-primary-600 text-white' : 'bg-ink-200 text-ink-500'" 
                         class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-semibold transition-colors">
                        <template x-if="setupStep > 1">
                            <i class="bi bi-check-lg"></i>
                        </template>
                        <template x-if="setupStep <= 1">
                            <span>1</span>
                        </template>
                </div>
                    <span :class="setupStep >= 1 ? 'text-ink-700' : 'text-ink-400'" class="text-sm font-medium hidden sm:inline">Hardcover</span>
                        </div>
                <div class="w-6 h-0.5 bg-ink-200"></div>
                <div class="flex items-center gap-2">
                    <div :class="setupStep >= 2 ? 'bg-primary-600 text-white' : 'bg-ink-200 text-ink-500'" 
                         class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-semibold transition-colors">
                        <template x-if="setupStep > 2">
                            <i class="bi bi-check-lg"></i>
                        </template>
                        <template x-if="setupStep <= 2">
                            <span>2</span>
                        </template>
                    </div>
                    <span :class="setupStep >= 2 ? 'text-ink-700' : 'text-ink-400'" class="text-sm font-medium hidden sm:inline">Calibre</span>
                                    </div>
                <div class="w-6 h-0.5 bg-ink-200"></div>
                <div class="flex items-center gap-2">
                    <div :class="setupStep >= 3 ? 'bg-primary-600 text-white' : 'bg-ink-200 text-ink-500'" 
                         class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-semibold transition-colors">
                        <template x-if="setupStep > 3">
                            <i class="bi bi-check-lg"></i>
                        </template>
                        <template x-if="setupStep <= 3">
                            <span>3</span>
                        </template>
                                </div>
                    <span :class="setupStep >= 3 ? 'text-ink-700' : 'text-ink-400'" class="text-sm font-medium hidden sm:inline">Prowlarr</span>
                            </div>
                    </div>

            <!-- Step 1: Hardcover API Key -->
            <div x-show="setupStep === 1" class="space-y-6">
                <div>
                    <label class="block text-sm font-semibold text-ink-700 mb-2">Hardcover API Key</label>
                    <p class="text-sm text-ink-500 mb-3">
                        Get your API key from 
                        <a href="https://hardcover.app/account/api" target="_blank" class="text-primary-600 hover:text-primary-700 hover:underline">hardcover.app/account/api</a>
                    </p>
                    <input 
                        type="text" 
                        x-model="hardcoverApiKeyInput"
                        :class="{'error': apiKeyError, 'success': apiKeySuccess}"
                        class="input-field font-mono text-sm"
                        placeholder="Paste your API key here"
                        @keyup.enter="validateHardcoverKey()"
                    >
                    <p class="text-xs text-ink-400 mt-2">
                        <i class="bi bi-info-circle"></i>
                        Copy the key exactly as shown on Hardcover
                    </p>
                        </div>
                
                <!-- Error/Success Messages -->
                <div x-show="apiKeyError" class="flex items-start gap-3 p-4 bg-red-50 border border-red-200 rounded-xl">
                    <i class="bi bi-exclamation-circle text-red-500 flex-shrink-0 mt-0.5"></i>
                    <p class="text-sm text-red-700" x-text="apiKeyError"></p>
                                </div>
                <div x-show="apiKeySuccess" class="flex items-start gap-3 p-4 bg-green-50 border border-green-200 rounded-xl">
                    <i class="bi bi-check-circle text-green-500 flex-shrink-0 mt-0.5"></i>
                    <p class="text-sm text-green-700">API key verified successfully!</p>
                    </div>

                <button 
                    @click="validateHardcoverKey()"
                    :disabled="validatingApiKey || !hardcoverApiKeyInput.trim()"
                    class="btn btn-primary w-full"
                >
                    <template x-if="validatingApiKey">
                        <span class="flex items-center gap-2">
                            <span class="spinner"></span>
                            Verifying...
                        </span>
                            </template>
                    <template x-if="!validatingApiKey">
                        <span>Verify & Continue</span>
                    </template>
                </button>
                        </div>

            <!-- Step 2: Calibre Library -->
            <div x-show="setupStep === 2" class="space-y-6">
                <div>
                    <label class="block text-sm font-semibold text-ink-700 mb-2">Calibre Library Location</label>
                    <p class="text-sm text-ink-500 mb-3">
                        Select the folder containing your Calibre library (with metadata.db)
                    </p>
                    
                    <!-- Current Path Display -->
                    <div class="flex items-center gap-2 p-3 bg-ink-50 rounded-xl mb-4">
                        <i class="bi bi-folder text-ink-400"></i>
                        <span class="text-sm font-mono text-ink-600 truncate" x-text="browserPath || 'Select a directory...'"></span>
                    </div>

                    <!-- Directory Browser -->
                    <div class="border-2 border-ink-200 rounded-xl max-h-64 overflow-y-auto">
                        <!-- Parent Directory -->
                        <div 
                            x-show="browserParent"
                            @click="browseTo(browserParent)"
                            class="dir-item border-b border-ink-100"
                        >
                            <i class="bi bi-arrow-up text-ink-400"></i>
                            <span class="text-ink-600">..</span>
                            </div>

                        <!-- Directory Entries -->
                        <template x-for="entry in browserEntries" :key="entry.path">
                            <div 
                                @click="entry.is_calibre_library ? selectCalibreLibrary(entry.path) : browseTo(entry.path)"
                                :class="{'calibre': entry.is_calibre_library}"
                                class="dir-item"
                            >
                                <i :class="entry.is_calibre_library ? 'bi-database text-green-500' : 'bi-folder text-ink-400'" class="bi"></i>
                                <span :class="entry.is_calibre_library ? 'text-green-700 font-semibold' : 'text-ink-700'" x-text="entry.name"></span>
                                <span x-show="entry.is_calibre_library" class="ml-auto text-xs text-green-600 font-medium">Calibre Library</span>
                                    </div>
                                </template>
                        
                        <!-- Empty State -->
                        <div x-show="browserEntries.length === 0" class="p-8 text-center text-ink-400">
                            <i class="bi bi-folder-x text-2xl opacity-50"></i>
                            <p class="text-sm mt-2">No subdirectories found</p>
                            </div>
                        </div>
                </div>

                <!-- Selected Library -->
                <div x-show="calibreLibraryPath" class="flex items-start gap-3 p-4 bg-green-50 border border-green-200 rounded-xl">
                    <i class="bi bi-check-circle text-green-500 flex-shrink-0 mt-0.5"></i>
                    <div>
                        <p class="text-sm font-semibold text-green-700">Library selected</p>
                        <p class="text-xs text-green-600 font-mono mt-1" x-text="calibreLibraryPath"></p>
                        </div>
                                        </div>
                
                <!-- Error Message -->
                <div x-show="calibreError" class="flex items-start gap-3 p-4 bg-red-50 border border-red-200 rounded-xl">
                    <i class="bi bi-exclamation-circle text-red-500 flex-shrink-0 mt-0.5"></i>
                    <p class="text-sm text-red-700" x-text="calibreError"></p>
                                    </div>
                
                <div class="flex gap-3">
                    <button @click="setupStep = 1" class="btn btn-secondary flex-1">
                        <i class="bi bi-arrow-left"></i>
                        Back
                    </button>
                    <button 
                        @click="completeSetup()"
                        :disabled="!calibreLibraryPath || verifyingCalibre"
                        class="btn btn-primary flex-1"
                    >
                        <template x-if="verifyingCalibre">
                            <span class="flex items-center gap-2">
                                <span class="spinner"></span>
                                Verifying...
                            </span>
                            </template>
                        <template x-if="!verifyingCalibre">
                            <span>Complete Setup</span>
                        </template>
                    </button>
                        </div>
                    </div>

            <!-- Step 3: Prowlarr (Optional) -->
            <div x-show="setupStep === 3" class="space-y-6">
                <div>
                    <label class="block text-sm font-semibold text-ink-700 mb-2">Prowlarr URL</label>
                    <p class="text-sm text-ink-500 mb-3">
                        Enter your Prowlarr instance URL (e.g., http://localhost:9696)
                    </p>
                    <input 
                        type="text" 
                        x-model="prowlarrUrlInput"
                        class="input-field"
                        placeholder="http://localhost:9696"
                    >
                            </div>
                
                <div>
                    <label class="block text-sm font-semibold text-ink-700 mb-2">Prowlarr API Key</label>
                    <p class="text-sm text-ink-500 mb-3">
                        Get your API key from Prowlarr Settings → General → API Key
                    </p>
                    <input 
                        type="text" 
                        x-model="prowlarrApiKeyInput"
                        class="input-field font-mono text-sm"
                        placeholder="Paste your API key here"
                    >
                                            </div>
                
                <!-- Error/Success Messages -->
                <div x-show="prowlarrError" class="flex items-start gap-3 p-4 bg-red-50 border border-red-200 rounded-xl">
                    <i class="bi bi-exclamation-circle text-red-500 flex-shrink-0 mt-0.5"></i>
                    <p class="text-sm text-red-700" x-text="prowlarrError"></p>
                                        </div>
                <div x-show="prowlarrSuccess" class="flex items-start gap-3 p-4 bg-green-50 border border-green-200 rounded-xl">
                    <i class="bi bi-check-circle text-green-500 flex-shrink-0 mt-0.5"></i>
                    <p class="text-sm text-green-700">Prowlarr configured successfully!</p>
                                        </div>
                
                <div class="flex gap-3">
                    <button @click="setupStep = 2" class="btn btn-secondary flex-1">
                        <i class="bi bi-arrow-left"></i>
                        Back
                    </button>
                    <button 
                        @click="validateProwlarr()"
                        :disabled="validatingProwlarr || !prowlarrUrlInput.trim() || !prowlarrApiKeyInput.trim()"
                        class="btn btn-primary flex-1"
                    >
                        <template x-if="validatingProwlarr">
                            <span class="flex items-center gap-2">
                                <span class="spinner"></span>
                                Verifying...
                            </span>
                                </template>
                        <template x-if="!validatingProwlarr">
                            <span>Verify & Complete</span>
                    </template>
                    </button>
                    <button 
                        @click="skipProwlarr()"
                        class="btn btn-secondary"
                    >
                        Skip
                    </button>
                                </div>
                                            </div>
                                            </div>
                                        </div>

    <!-- Main App -->
    <div x-show="!showSetup" x-cloak class="min-h-screen">
        
        <!-- New Two-Row Header -->
        <header
            class="sticky top-0 z-50 bg-white safe-area-top transition-shadow duration-200 border-b border-ink-200"
            x-data="{ scrolled: false }"
            @scroll.window="scrolled = window.scrollY > 10"
            :class="{ 'header-scrolled': scrolled }"
        >
            <!-- Row 1: Logo, Search, Settings -->
            <div class="border-b border-ink-100">
                <div class="max-w-7xl mx-auto px-4 py-3">
                    <div class="flex items-center gap-4">
                        <!-- Logo with icon -->
                        <a @click.prevent="activeView = 'yourBooks'; searchQuery = ''; selectedBook = null; selectedHardcoverBook = null; showSettings = false; showSearchModal = false; window.scrollTo({ top: 0, behavior: 'smooth' })"
                           href="#"
                           class="flex items-center gap-2 cursor-pointer hover:opacity-80 transition-opacity shrink-0">
                            <img src="/folio.svg" alt="Folio" class="w-8 h-8">
                            <span class="font-logo text-2xl font-bold text-ink-900 pt-2">folio</span>
                        </a>

                        <!-- Search Bar -->
                        <div class="flex-1 relative">
                            <div class="relative flex items-center">
                                <i class="bi bi-search absolute left-3 text-ink-400 text-lg pointer-events-none"></i>
                                <input
                                    type="text"
                                    x-model="searchQuery"
                                    @input.debounce.300ms="searchBooks()"
                                    placeholder="Search your library..."
                                    class="w-full pl-10 pr-12 py-2.5 bg-ink-50 border border-ink-200 rounded-lg text-sm text-ink-900 placeholder-ink-400 focus:outline-none focus:ring-2 focus:ring-ink-900 focus:border-transparent transition-all"
                                >
                                <button
                                    @click="openCameraCapture()"
                                    class="absolute right-2 p-1.5 text-ink-600 hover:text-ink-900 hover:bg-ink-100 rounded-md transition-colors"
                                    title="Scan book cover"
                                >
                                    <i class="bi bi-camera text-lg"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Settings Button -->
                        <button
                            @click="showSettings = true; hardcoverApiKeyInput = ''; prowlarrUrlInput = prowlarrUrl || ''; prowlarrApiKeyInput = ''; apiKeyError = ''; prowlarrError = ''; apiKeySuccess = false; prowlarrSuccess = false;"
                            class="p-2.5 text-ink-600 hover:text-ink-900 hover:bg-ink-50 rounded-lg transition-colors shrink-0"
                            title="Settings"
                        >
                            <i class="bi bi-gear text-xl"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Row 2: Navigation Tabs -->
            <div class="max-w-7xl mx-auto">
                <div class="grid grid-cols-2 border-b-2 border-transparent">
                    <button
                        @click="activeView = 'yourBooks'; window.scrollTo({ top: 0, behavior: 'smooth' })"
                        :class="activeView === 'yourBooks' ? 'tab-active' : 'tab-inactive'"
                        class="tab-btn"
                    >
                        <i class="bi bi-book text-lg"></i>
                        <span>Your Books</span>
                    </button>
                    <button
                        @click="activeView = 'discover'; window.scrollTo({ top: 0, behavior: 'smooth' })"
                        :class="activeView === 'discover' ? 'tab-active' : 'tab-inactive'"
                        class="tab-btn"
                    >
                        <i class="bi bi-compass text-lg"></i>
                        <span>Discover</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Search Modal -->
        <div x-show="showSearchModal" x-cloak @click.self="showSearchModal = false"
             class="fixed inset-0 z-[60] modal-overlay flex items-start justify-center pt-20">
            <div x-show="showSearchModal" x-transition
                 @keydown.escape.window="showSearchModal = false"
                 class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden">
                <!-- Search Header -->
                <div class="p-4 border-b border-ink-200">
                    <div class="relative flex items-center gap-3">
                        <i class="bi bi-search text-ink-400 text-xl"></i>
                        <input
                            type="text"
                            x-model="searchQuery"
                            x-ref="searchModalInput"
                            @input.debounce.300ms="searchBooks()"
                            placeholder="Search for books..."
                            class="flex-1 bg-transparent border-none outline-none text-lg text-ink-900 placeholder-ink-400"
                            @keydown.escape="showSearchModal = false"
                        >
                        <button
                            @click="showSearchModal = false"
                            class="p-2 hover:bg-ink-50 rounded-lg transition-colors flex items-center justify-center"
                            title="Close"
                        >
                            <i class="bi bi-x-lg text-ink-500"></i>
                        </button>
                    </div>
                </div>

                <!-- Search Results Container -->
                <div class="max-h-[60vh] overflow-y-auto p-4">
                    <!-- Loading State -->
                    <div x-show="loadingSearchiTunes && searchiTunesResults.length === 0" class="py-12 px-4 text-center">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-ink-100 rounded-full mb-4">
                            <div class="spinner w-6 h-6"></div>
                        </div>
                        <h3 class="text-lg font-semibold text-ink-700 mb-2">Searching...</h3>
                        <p class="text-ink-500 text-sm">Finding books for you</p>
                    </div>

                    <!-- Empty State -->
                    <div x-show="!searchQuery && !loadingSearchiTunes" class="py-12 px-4 text-center">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-ink-100 rounded-full mb-4">
                            <i class="bi bi-search text-2xl text-ink-400"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-ink-700 mb-2">Search for books</h3>
                        <p class="text-ink-500 text-sm">Start typing to find books in your library and beyond</p>
                    </div>

                    <!-- Search Results Grid -->
                    <div x-show="searchQuery && searchiTunesResults.length > 0" class="space-y-4">
                        <div class="flex items-center justify-between">
                            <h3 class="text-sm font-semibold text-ink-700">Search Results</h3>
                            <span class="text-ink-500 text-sm" x-text="`${searchiTunesResults.length} books`"></span>
                        </div>
                        <div class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 gap-3">
                            <template x-for="book in searchiTunesResults" :key="book.id">
                                <div @click="openHardcoverModal(book); showSearchModal = false" class="book-card cursor-pointer">
                                    <div class="book-cover relative">
                                        <img :src="book.image" :alt="book.title" loading="lazy" class="w-full h-full object-cover"
                                             @error="$el.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 150%22><rect fill=%22%23e5e7eb%22 width=%22100%22 height=%22150%22/><text x=%2250%22 y=%2275%22 text-anchor=%22middle%22 fill=%22%239ca3af%22 font-size=%2212%22>No Cover</text></svg>'">
                                        <!-- Overlay badge for library -->
                                        <span x-show="book.inLibrary" class="absolute top-1 right-1 w-6 h-6 bg-green-500 rounded-full flex items-center justify-center shadow-lg">
                                            <i class="bi bi-check-lg text-white text-xs"></i>
                                        </span>
                                        <!-- Overlay badge for requested -->
                                        <span x-show="book.requested && !book.inLibrary" class="absolute top-1 right-1 w-6 h-6 bg-amber-500 rounded-full flex items-center justify-center shadow-lg">
                                            <i class="bi bi-download text-white text-xs"></i>
                                        </span>
                                    </div>
                                    <h3 class="mt-1.5 text-xs font-semibold text-ink-900 line-clamp-2 leading-tight" x-text="book.title"></h3>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- No Results -->
                    <div x-show="searchQuery && !loadingSearchiTunes && searchiTunesResults.length === 0" class="py-12 px-4 text-center">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-ink-100 rounded-full mb-4">
                            <i class="bi bi-search text-2xl text-ink-400"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-ink-700 mb-2">No results found</h3>
                        <p class="text-ink-500 text-sm">Try a different search term</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto safe-area-bottom">
            
            <!-- Loading State -->
            <div x-show="libraryLoading" class="py-8">
                <div class="flex flex-col items-center justify-center gap-3">
                    <div class="spinner w-6 h-6"></div>
                    <p class="text-ink-500 text-sm">Loading your library...</p>
                                </div>
                            </div>

            <!-- Search Results -->
            <section x-show="searchQuery && !libraryLoading" class="px-4 py-6 space-y-6">
                <!-- Loading State -->
                <div x-show="loadingSearchiTunes && searchiTunesResults.length === 0" class="py-12 px-4 text-center">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-ink-100 rounded-full mb-4">
                        <div class="spinner w-6 h-6"></div>
                    </div>
                    <h3 class="text-lg font-semibold text-ink-700 mb-2">Searching...</h3>
                    <p class="text-ink-500 text-sm">Finding books for you</p>
                </div>

                <!-- iTunes Search Results -->
                <div x-show="searchiTunesResults.length > 0">
                    <div class="section-header">
                        <h2 class="section-title">Search Results</h2>
                        <span class="text-ink-500 text-sm" x-text="`${searchiTunesResults.length} books`"></span>
                    </div>
                    <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-3" x-ref="searchResultsGrid">
                        <template x-for="book in searchiTunesResults" :key="book.id">
                            <div @click="openHardcoverModal(book)" class="book-card cursor-pointer">
                                <div class="book-cover relative">
                                    <img :src="book.image" :alt="book.title" loading="lazy" class="w-full h-full object-cover"
                                         @error="$el.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 150%22><rect fill=%22%23e5e7eb%22 width=%22100%22 height=%22150%22/><text x=%2250%22 y=%2275%22 text-anchor=%22middle%22 fill=%22%239ca3af%22 font-size=%2212%22>No Cover</text></svg>'">
                                    <!-- Overlay badge for library -->
                                    <span x-show="book.inLibrary" class="absolute top-1 right-1 w-6 h-6 bg-green-500 rounded-full flex items-center justify-center shadow-lg">
                                        <i class="bi bi-check-lg text-white text-xs"></i>
                                    </span>
                                    <!-- Overlay badge for requested -->
                                    <span x-show="book.requested && !book.inLibrary" class="absolute top-1 right-1 w-6 h-6 bg-amber-500 rounded-full flex items-center justify-center shadow-lg">
                                        <i class="bi bi-download text-white text-xs"></i>
                                    </span>
                                </div>
                                <h3 class="mt-1.5 text-xs font-semibold text-ink-900 line-clamp-2 leading-tight" x-text="book.title"></h3>
                                <p class="text-xs text-ink-500 line-clamp-1" x-text="book.author"></p>
                                <!-- Rating stars -->
                                <div x-show="book.rating" class="mt-1 flex items-center gap-1">
                                    <div class="rating">
                                        <template x-for="i in 5" :key="i">
                                            <i :class="i <= Math.round(book.rating) ? 'bi bi-star-fill star' : 'bi bi-star star star-empty'"></i>
                                        </template>
                                    </div>
                                    <span class="text-xs text-ink-400 ml-1" x-text="book.rating?.toFixed(1)"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                    <!-- Loading more indicator -->
                    <div x-show="loadingSearchiTunes && searchiTunesResults.length > 0" class="py-4 text-center">
                        <div class="flex items-center justify-center gap-2 text-ink-500">
                            <div class="spinner w-4 h-4"></div>
                            <span class="text-sm">Loading more results...</span>
                        </div>
                    </div>
                </div>

                <!-- No Results -->
                <div x-show="!loadingSearchiTunes && searchiTunesResults.length === 0 && searchQuery" class="py-12 px-4 text-center">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-ink-100 rounded-full mb-4">
                        <i class="bi bi-search text-2xl text-ink-400"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-ink-700 mb-2">No results found</h3>
                    <p class="text-ink-500 text-sm">Try a different search term</p>
                </div>
            </section>
            
            <!-- ============================================ -->
            <!-- YOUR BOOKS VIEW -->
            <!-- ============================================ -->
            <section x-show="activeView === 'yourBooks' && !searchQuery && !libraryLoading && (books.length > 0 || requestedBooks.length > 0)" class="pt-4 pb-4 view-fade-enter">
                <!-- Filter & Sort Button -->
                <div class="px-4 mb-4">
                    <button
                        @click="showYourBooksFilterModal = true"
                        class="flex items-center gap-2 px-4 py-2 bg-ink-100 text-ink-700 hover:bg-ink-200 rounded-lg transition-colors text-sm font-medium"
                    >
                        <i class="bi bi-funnel"></i>
                        <span>Filter & Sort</span>
                        <span x-show="yourBooksFilter !== 'all' || yourBooksSortBy !== 'recent'" class="ml-1 w-2 h-2 bg-sage-500 rounded-full"></span>
                    </button>
                </div>

                <!-- Your Books Grid - Responsive 3-6 Column Layout -->
                <div class="px-4">
                    <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-3 md:gap-4">
                        <template x-for="book in getFilteredYourBooks()" :key="book.id">
                            <div @click="book.isRequested ? openHardcoverModal(book) : openBookModal(book)" class="book-card cursor-pointer">
                                <div class="book-cover relative">
                                    <img :src="book.isRequested ? book.image : `/api/cover/${book.id}?v=${coverVersion}`"
                                         :alt="book.title"
                                         loading="lazy"
                                         @error="$el.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 150%22><rect fill=%22%23e5e7eb%22 width=%22100%22 height=%22150%22/><text x=%2250%22 y=%2275%22 text-anchor=%22middle%22 fill=%22%239ca3af%22 font-size=%2212%22>No Cover</text></svg>'">
                                    <!-- Requested Badge -->
                                    <div x-show="book.isRequested" class="absolute top-1.5 left-1.5 z-10">
                                        <span class="badge-requested">
                                            <i class="bi bi-download"></i>
                                            Requested
                                        </span>
                                    </div>
                                    <!-- Kobo Sync Badge -->
                                    <div x-show="book.isLibraryBook && isInKoboSync(book)" class="absolute top-1.5 left-1.5 z-10">
                                        <span class="badge-kobo">
                                            <i class="bi bi-check-circle-fill"></i>
                                            Kobo
                                        </span>
                                    </div>
                                </div>
                                <h3 class="mt-1.5 text-xs font-semibold text-ink-900 line-clamp-2 leading-tight" x-text="book.title"></h3>
                                <p class="text-xs text-ink-500 line-clamp-1" x-text="formatAuthors(book.authors)"></p>
                            </div>
                        </template>
                    </div>

                    <!-- Infinite Scroll Indicator -->
                    <div x-show="loadingMoreBooks" class="h-20 flex items-center justify-center py-8">
                        <div class="spinner w-6 h-6"></div>
                    </div>
                </div>
            </section>

            <!-- ============================================ -->
            <!-- DISCOVER VIEW -->
            <!-- ============================================ -->
            <section x-show="activeView === 'discover' && !searchQuery && !libraryLoading" class="pt-4 pb-4 view-fade-enter">
                <!-- Card Catalog Button -->
                <div class="px-4 mb-6">
                    <button
                        @click="openCardCatalog()"
                        class="w-full btn btn-primary py-4 text-lg font-semibold"
                    >
                        Open Card Catalog
                    </button>
                </div>

                    <!-- Recent Releases -->
                    <div x-show="hardcoverRecentReleases.length > 0" class="px-4">
                        <h2 class="section-title mb-3">Recent Releases</h2>
                        <div class="overflow-x-auto">
                            <div class="grid grid-cols-3 gap-3">
                                <template x-for="book in hardcoverRecentReleases.slice(0, 6)" :key="book.id">
                                    <div @click="openHardcoverModal(book)" class="book-card cursor-pointer">
                                        <div class="book-cover relative">
                                            <img :src="book.image" :alt="book.title" loading="lazy" class="w-full h-full object-cover"
                                                 @error="$el.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 150%22><rect fill=%22%23e5e7eb%22 width=%22100%22 height=%22150%22/><text x=%2250%22 y=%2275%22 text-anchor=%22middle%22 fill=%22%239ca3af%22 font-size=%2212%22>No Cover</text></svg>'">
                                        </div>
                                        <h3 class="mt-1.5 text-xs font-semibold text-ink-900 line-clamp-2 leading-tight" x-text="book.title"></h3>
                                        <p class="text-xs text-ink-500 line-clamp-1" x-text="book.author"></p>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- Most Popular from 2025 -->
                    <div x-show="hardcoverTrendingMonth.length > 0" class="px-4">
                        <h2 class="section-title mb-3">Most Popular from 2025</h2>
                        <div class="overflow-x-auto">
                            <div class="grid grid-cols-3 gap-3">
                                <template x-for="book in hardcoverTrendingMonth.slice(0, 6)" :key="book.id">
                                    <div @click="openHardcoverModal(book)" class="book-card cursor-pointer">
                                        <div class="book-cover relative">
                                            <img :src="book.image" :alt="book.title" loading="lazy" class="w-full h-full object-cover"
                                                 @error="$el.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 150%22><rect fill=%22%23e5e7eb%22 width=%22100%22 height=%22150%22/><text x=%2250%22 y=%2275%22 text-anchor=%22middle%22 fill=%22%239ca3af%22 font-size=%2212%22>No Cover</text></svg>'">
                                        </div>
                                        <h3 class="mt-1.5 text-xs font-semibold text-ink-900 line-clamp-2 leading-tight" x-text="book.title"></h3>
                                        <p class="text-xs text-ink-500 line-clamp-1" x-text="book.author"></p>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- Curated Lists -->
                    <template x-for="section in hardcoverSections" :key="section.title">
                        <div class="px-4">
                            <h2 class="section-title mb-3" x-text="section.title"></h2>
                            <p x-show="section.description" class="text-ink-500 text-sm mb-2 -mt-1" x-text="section.description"></p>
                            <div class="overflow-x-auto">
                                <div class="grid grid-cols-3 gap-3">
                                    <template x-for="book in section.books.slice(0, 6)" :key="book.id">
                                        <div @click="openHardcoverModal(book)" class="book-card cursor-pointer">
                                            <div class="book-cover relative">
                                                <img :src="book.image" :alt="book.title" loading="lazy" class="w-full h-full object-cover"
                                                     @error="$el.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 150%22><rect fill=%22%23e5e7eb%22 width=%22100%22 height=%22150%22/><text x=%2250%22 y=%2275%22 text-anchor=%22middle%22 fill=%22%239ca3af%22 font-size=%2212%22>No Cover</text></svg>'">
                                            </div>
                                            <h3 class="mt-1.5 text-xs font-semibold text-ink-900 line-clamp-2 leading-tight" x-text="book.title"></h3>
                                            <p class="text-xs text-ink-500 line-clamp-1" x-text="book.author"></p>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </section>
                <!-- Empty State -->
            <div x-show="!libraryLoading && books.length === 0 && requestedBooks.length === 0 && !searchQuery" class="py-12 px-4 text-center">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-ink-100 rounded-full mb-4">
                    <i class="bi bi-journal-x text-2xl text-ink-400"></i>
                    </div>
                <h3 class="text-lg font-semibold text-ink-700 mb-2">No books found</h3>
                <p class="text-ink-500 text-sm max-w-xs mx-auto">Your Calibre library appears to be empty. Add some books to get started!</p>
                </div>


        </main>
        
        <!-- Footer with Settings Link -->
        <footer x-show="!showSetup && !searchQuery" class="py-6 px-4 border-t border-ink-200 bg-ink-50">
            <div class="max-w-7xl mx-auto flex items-center justify-center">
                <button 
                    @click="showSettings = true; hardcoverApiKeyInput = ''; prowlarrUrlInput = prowlarrUrl || ''; prowlarrApiKeyInput = ''; apiKeyError = ''; prowlarrError = ''; apiKeySuccess = false; prowlarrSuccess = false;" 
                    class="text-sm text-ink-500 hover:text-ink-700 transition-colors flex items-center gap-2"
                >
                    <i class="bi bi-gear"></i>
                    <span>Settings</span>
                </button>
            </div>
        </footer>
    </div>

    <!-- Book Detail Modal (Local Library) -->
    <div x-show="selectedBook" x-cloak @click.self="closeBookModal()" 
         class="fixed inset-0 z-[60] modal-overlay flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div x-show="selectedBook" x-transition:enter="slide-up" 
             class="bg-ink-100 w-full sm:max-w-[720px] sm:rounded-2xl rounded-t-[20px] max-h-[90vh] flex flex-col shadow-2xl border border-ink-200">
            
            <!-- Sticky Header -->
            <div class="flex justify-between items-center p-4 border-b border-ink-100 sticky top-0 bg-white z-10 rounded-t-[20px] sm:rounded-t-2xl">
                <strong class="text-ink-900 font-semibold">Book Details</strong>
                <div class="flex gap-2">
                    <button @click="enterEditMode()" title="Edit" class="p-3 hover:bg-ink-50 rounded-lg transition-colors flex items-center justify-center min-h-[44px] min-w-[44px]">
                        <i class="bi bi-pencil text-ink-600"></i>
                                        </button>
                    <button x-show="selectedBookiTunesMatch" @click="updateMetadataFromiTunes()" :disabled="updatingMetadata" title="Update from iTunes" class="p-3 hover:bg-ink-50 rounded-lg transition-colors flex items-center justify-center min-h-[44px] min-w-[44px]">
                        <span x-show="!updatingMetadata"><i class="bi bi-search text-ink-600"></i></span>
                        <span x-show="updatingMetadata" class="spinner w-5 h-5"></span>
                                        </button>
                    <button @click="closeBookModal()" title="Close" class="p-3 hover:bg-ink-50 rounded-lg transition-colors flex items-center justify-center min-h-[44px] min-w-[44px]">
                        <i class="bi bi-x-lg text-ink-600"></i>
                                        </button>
                                    </div>
                                </div>

            <!-- Scrollable Body -->
            <div class="flex-1 overflow-y-auto p-5">
                <!-- View Mode -->
                <div x-show="!isEditMode" class="sm:grid sm:grid-cols-[180px_1fr] sm:gap-6">
                                    <!-- Cover -->
                    <div class="mb-5 sm:mb-0">
                        <img :src="`/api/cover/${selectedBook?.id}?v=${coverVersion}`" :alt="selectedBook?.title" 
                             class="w-full max-w-[180px] mx-auto sm:mx-0 block rounded-xl shadow-lg">
                                    </div>

                    <!-- Content -->
                    <div class="space-y-3">
                                        <div>
                            <h1 class="text-[22px] font-semibold text-ink-900 mb-1" x-text="selectedBook?.title"></h1>
                            <div class="text-base text-ink-600" x-text="formatAuthors(selectedBook?.authors)"></div>
                            <div x-show="selectedBook?.pubdate" class="text-sm text-ink-500 mt-0.5" x-text="selectedBook?.pubdate ? new Date(selectedBook.pubdate).getFullYear() : ''"></div>
                                        </div>

                        <!-- Description -->
                        <div x-show="selectedBook?.comments" class="text-[15px] leading-relaxed text-ink-700" x-html="selectedBook?.comments"></div>

                        <!-- Tags/Genres -->
                        <div x-show="selectedBook?.tags?.length" class="flex flex-wrap gap-1.5 pt-2">
                            <template x-for="tag in (selectedBook?.tags || [])" :key="tag">
                                <span class="px-3.5 py-1.5 bg-primary-50 text-primary-600 border border-primary-200 rounded-full text-xs" x-text="tag"></span>
                            </template>
                                        </div>

                        <!-- Series -->
                        <div x-show="selectedBook?.series" class="text-sm text-ink-500 pt-2">
                            <span class="font-semibold">Series:</span> <span x-text="selectedBook?.series"></span><span x-show="selectedBook?.series_index" x-text="` (#${selectedBook?.series_index})`"></span>
                                            </div>

                        <!-- Publisher -->
                        <div x-show="selectedBook?.publisher" class="text-sm text-ink-500">
                            <span class="font-semibold">Publisher:</span> <span x-text="selectedBook?.publisher"></span>
                                        </div>

                        <!-- Formats -->
                        <div x-show="selectedBook?.formats?.length" class="text-sm text-ink-500">
                            <span class="font-semibold">Formats:</span> 
                            <template x-for="(format, index) in (selectedBook?.formats || [])" :key="format">
                                <span><span x-text="format"></span><span x-show="index < selectedBook.formats.length - 1">, </span></span>
                                                </template>
                                        </div>
                                    </div>
                                </div>

                <!-- Edit Mode -->
                <div x-show="isEditMode" class="sm:grid sm:grid-cols-[180px_1fr] sm:gap-6">
                    <!-- Cover Upload -->
                    <div class="mb-5 sm:mb-0">
                        <label 
                            @drop.prevent="handleCoverUpload($event)" 
                                                     @dragover.prevent
                            class="block cursor-pointer group">
                            <input type="file" accept="image/*" @change="handleCoverUpload($event)" class="hidden" />
                            <div class="relative">
                                <img :src="editingBook?.coverPreview" :alt="editingBook?.title" 
                                     class="w-full max-w-[180px] mx-auto sm:mx-0 block rounded-xl shadow-lg group-hover:opacity-75 transition-opacity">
                                <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                    <div class="bg-ink-900/75 text-white px-3 py-2 rounded-lg text-sm">
                                        <i class="bi bi-upload"></i> Change Cover
                                                    </div>
                                                    </div>
                                                </div>
                            <div class="text-xs text-ink-500 text-center mt-2">Drag & drop or tap to upload</div>
                        </label>
                                        </div>

                    <!-- Edit Form -->
                    <div class="space-y-4">
                                            <!-- Title -->
                                            <div>
                            <label class="block text-sm font-semibold text-ink-700 mb-1">Title</label>
                            <input type="text" x-model="editingBook.title" 
                                   class="w-full px-3 py-2 border border-ink-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-ocean-500">
                                            </div>

                                            <!-- Author -->
                        <div class="relative">
                            <label class="block text-sm font-semibold text-ink-700 mb-1">Author</label>
                            <input type="text" x-model="editingBook.authors" 
                                   @input="filterAuthorSuggestions()"
                                   @focus="filterAuthorSuggestions()"
                                   @blur="setTimeout(() => showAuthorSuggestions = false, 200)"
                                   class="w-full px-3 py-2 border border-ink-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-ocean-500">
                            <div x-show="showAuthorSuggestions" class="absolute z-20 w-full mt-1 bg-white border border-ink-200 rounded-lg shadow-lg max-h-40 overflow-y-auto">
                                <template x-for="author in authorSuggestions" :key="author">
                                    <button @click="selectAuthor(author)" 
                                            class="w-full px-3 py-2 text-left hover:bg-ink-50 text-sm text-ink-700">
                                        <span x-text="author"></span>
                                    </button>
                                                    </template>
                                                </div>
                                            </div>

                        <!-- Year -->
                                                <div>
                            <label class="block text-sm font-semibold text-ink-700 mb-1">Year</label>
                            <input type="text" x-model="editingBook.year" placeholder="2024"
                                   class="w-full px-3 py-2 border border-ink-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-ocean-500">
                                                </div>

                        <!-- Tags/Genres -->
                        <div class="relative">
                            <label class="block text-sm font-semibold text-ink-700 mb-1">Genres (comma-separated)</label>
                            <input type="text" x-model="editingBook.tags" 
                                   @input="filterTagSuggestions()"
                                   @focus="filterTagSuggestions()"
                                   @blur="setTimeout(() => showTagSuggestions = false, 200)"
                                   placeholder="Science Fiction, Fantasy, Adventure"
                                   class="w-full px-3 py-2 border border-ink-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-ocean-500">
                            <div x-show="showTagSuggestions" class="absolute z-20 w-full mt-1 bg-white border border-ink-200 rounded-lg shadow-lg max-h-40 overflow-y-auto">
                                <template x-for="tag in tagSuggestions" :key="tag">
                                    <button @click="selectTag(tag)" 
                                            class="w-full px-3 py-2 text-left hover:bg-ink-50 text-sm text-ink-700">
                                        <span x-text="tag"></span>
                                            </button>
                                                        </template>
                                                </div>
                                            </div>

                                            <!-- Description -->
                                            <div>
                            <label class="block text-sm font-semibold text-ink-700 mb-1">Description</label>
                            <textarea x-model="editingBook.comments" rows="6"
                                      class="w-full px-3 py-2 border border-ink-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-ocean-500 resize-none"></textarea>
                                            </div>
                </div>
            </div>
        </div>

            <!-- Sticky Footer -->
            <div class="p-4 border-t border-ink-200 sticky bottom-0 bg-ink-100">
                <!-- Edit Mode Footer -->
                <template x-if="isEditMode">
                                    <div class="flex gap-2">
                        <button @click="exitEditMode()" class="btn btn-secondary flex-1 py-3.5 justify-center">
                            Cancel
                        </button>
                        <button @click="saveEditedMetadata()" :disabled="savingMetadata" class="btn btn-primary flex-1 py-3.5 justify-center">
                            <span x-show="!savingMetadata" class="inline-flex items-center gap-2">
                                <i class="bi bi-check-lg"></i>
                                Save Changes
                            </span>
                            <span x-show="savingMetadata" class="inline-flex items-center gap-2">
                                <span class="spinner w-4 h-4"></span>
                                Saving...
                            </span>
                                        </button>
                                    </div>
                </template>
                
                <!-- View Mode Footer -->
                <template x-if="!isEditMode">
                    <button 
                        @click="toggleReadingListFromLibrary()" 
                        class="w-full btn btn-primary py-3.5 justify-center"
                    >
                        <template x-if="isInReadingList(selectedBook?.id) && readingListStatus === 'remove'">
                            <span class="inline-flex items-center gap-2">
                                <i class="bi bi-bookmark-dash"></i>
                                Remove from Kobo Sync
                                        </span>
                                                </template>
                        <template x-if="isInReadingList(selectedBook?.id) && readingListStatus !== 'remove'">
                            <span class="inline-flex items-center gap-2">
                                <i class="bi bi-check-lg"></i>
                                Added!
                                        </span>
                        </template>
                        <template x-if="!isInReadingList(selectedBook?.id)">
                            <span class="inline-flex items-center gap-2">
                                <i class="bi bi-bookmark-plus"></i>
                                Add to Kobo Sync
                            </span>
                                                </template>
                                            </button>
                </template>
                                        </div>
                                        </div>
                                    </div>

    <!-- Hardcover Book Modal -->
    <div x-show="selectedHardcoverBook" x-cloak @click.self="selectedHardcoverBook = null" 
         class="fixed inset-0 z-[60] modal-overlay flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div x-show="selectedHardcoverBook" x-transition:enter="slide-up" 
             class="bg-ink-100 w-full sm:max-w-[720px] sm:rounded-2xl rounded-t-[20px] max-h-[90vh] flex flex-col shadow-2xl border border-ink-200">
            
            <!-- Sticky Header -->
            <div class="flex justify-between items-center p-4 border-b border-ink-100 sticky top-0 bg-white z-10 rounded-t-[20px] sm:rounded-t-2xl">
                                <div class="flex items-center gap-2">
                    <strong class="text-ink-900 font-semibold">Book Details</strong>
                    <span x-show="selectedHardcoverBook?.inLibrary" class="px-2 py-0.5 bg-accent-100 text-accent-700 rounded text-xs font-semibold">
                        <i class="bi bi-check-lg"></i> In Library
                                        </span>
                    <span x-show="selectedHardcoverBook?.requested && !selectedHardcoverBook?.inLibrary" class="px-2 py-0.5 bg-amber-100 text-amber-700 rounded text-xs font-semibold">
                        <i class="bi bi-clock"></i> Requested
                                        </span>
                                    </div>
                <button @click="selectedHardcoverBook = null" title="Close" class="p-3 hover:bg-ink-50 rounded-lg transition-colors flex items-center justify-center min-h-[44px] min-w-[44px]">
                    <i class="bi bi-x-lg text-ink-600"></i>
                                </button>
                                </div>

            <!-- Scrollable Body -->
            <div class="flex-1 overflow-y-auto p-5">
                <div class="sm:grid sm:grid-cols-[180px_1fr] sm:gap-6">
                                <!-- Cover -->
                    <div class="mb-5 sm:mb-0">
                        <img :src="selectedHardcoverBook?.image" :alt="selectedHardcoverBook?.title" 
                             class="w-full max-w-[180px] mx-auto sm:mx-0 block rounded-xl shadow-lg">
                            </div>

                    <!-- Content -->
                    <div class="space-y-3">
                            <div>
                            <h1 class="text-[22px] font-semibold text-ink-900 mb-1" x-text="selectedHardcoverBook?.title"></h1>
                            <div class="text-base text-ink-600" x-text="selectedHardcoverBook?.author"></div>
                            <div x-show="selectedHardcoverBook?.year" class="text-sm text-ink-500 mt-0.5" x-text="selectedHardcoverBook?.year"></div>
                                    </div>

                                    <!-- Rating -->
                        <div x-show="selectedHardcoverBook?.rating" class="flex items-center gap-2">
                            <div class="rating flex">
                                        <template x-for="i in 5" :key="i">
                                    <i class="bi bi-star-fill text-sm" 
                                       :class="i <= Math.round(selectedHardcoverBook?.rating) ? 'text-amber-400' : 'text-ink-200'"></i>
                                        </template>
                                </div>
                            <span class="text-xs text-ink-500" x-text="`${selectedHardcoverBook?.rating?.toFixed(1)} (${selectedHardcoverBook?.ratings_count} ratings)`"></span>
                            </div>

                        <!-- Description -->
                        <div x-show="selectedHardcoverBook?.description" class="text-[15px] leading-relaxed text-ink-700" x-html="selectedHardcoverBook?.description"></div>

                        <!-- Pages -->
                        <div x-show="selectedHardcoverBook?.pages" class="text-sm text-ink-500">
                            <span class="font-semibold">Pages:</span> <span x-text="selectedHardcoverBook?.pages"></span>
                </div>
            </div>
        </div>
    </div>

            <!-- Sticky Footer -->
            <div class="p-4 border-t border-ink-200 sticky bottom-0 bg-ink-100">
                <template x-if="selectedHardcoverBook?.inLibrary">
                    <div class="flex flex-col sm:flex-row gap-2">
                        <button @click="viewInLibrary(selectedHardcoverBook)" class="w-full btn btn-secondary py-3.5 justify-center">
                            <i class="bi bi-book"></i>
                            View in Library
                                            </button>
                        <button @click="addLibraryBookToReadingList(selectedHardcoverBook)" class="w-full btn btn-primary py-3.5 justify-center">
                            <i class="bi bi-bookmark-plus"></i>
                            Add to Kobo Sync
                        </button>
                                </div>
                                        </template>
                <template x-if="!selectedHardcoverBook?.inLibrary && !selectedHardcoverBook?.requested">
                    <button @click="requestBookAndClose()" class="w-full btn btn-primary py-3.5 justify-center">
                        <i class="bi bi-plus-lg"></i>
                        Request This Book
                                            </button>
                                        </template>
                <template x-if="selectedHardcoverBook?.requested && !selectedHardcoverBook?.inLibrary">
                    <div class="flex flex-col sm:flex-row gap-2">
                        <button @click="searchProwlarr(selectedHardcoverBook); selectedHardcoverBook = null;"
                                :disabled="!prowlarrUrl || !prowlarrApiKey"
                                class="w-full btn btn-primary py-3.5 justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="bi bi-search"></i>
                            Search Prowlarr
                        </button>
                        <button @click="cancelRequest(selectedHardcoverBook)" class="w-full btn btn-secondary py-3.5 justify-center">
                            <i class="bi bi-x-lg"></i>
                            Cancel Request
                        </button>
                    </div>
                </template>
                            </div>
                                    </div>
                                    </div>

    <!-- Your Books Filter & Sort Modal -->
    <div x-show="showYourBooksFilterModal" x-cloak @click.self="showYourBooksFilterModal = false"
         class="fixed inset-0 z-[60] modal-overlay flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div x-show="showYourBooksFilterModal" x-transition:enter="slide-up"
             class="bg-white w-full sm:max-w-[400px] sm:rounded-2xl rounded-t-[20px] shadow-2xl border border-ink-200">

            <!-- Header -->
            <div class="flex justify-between items-center p-4 border-b border-ink-200">
                <h2 class="text-lg font-semibold text-ink-900">Filter & Sort</h2>
                <button @click="showYourBooksFilterModal = false" class="p-2 hover:bg-ink-50 rounded-lg transition-colors">
                    <i class="bi bi-x-lg text-ink-600"></i>
                </button>
            </div>

            <!-- Content -->
            <div class="p-4 space-y-6">
                <!-- Filter Section -->
                <div>
                    <h3 class="text-sm font-semibold text-ink-700 mb-3">Filter</h3>
                    <div class="space-y-2">
                        <button
                            @click="changeYourBooksFilter('all')"
                            :class="yourBooksFilter === 'all' ? 'bg-ink-900 text-white' : 'bg-ink-100 text-ink-700 hover:bg-ink-200'"
                            class="w-full px-4 py-3 text-sm font-medium rounded-lg transition-colors flex items-center gap-3"
                        >
                            <i class="bi bi-book text-base"></i>
                            <span>All Books</span>
                            <i x-show="yourBooksFilter === 'all'" class="bi bi-check-lg ml-auto"></i>
                        </button>
                        <button
                            @click="changeYourBooksFilter('kobo')"
                            :class="yourBooksFilter === 'kobo' ? 'bg-ink-900 text-white' : 'bg-ink-100 text-ink-700 hover:bg-ink-200'"
                            class="w-full px-4 py-3 text-sm font-medium rounded-lg transition-colors flex items-center gap-3"
                        >
                            <i class="bi bi-check-circle-fill text-base"></i>
                            <span>Kobo Sync</span>
                            <i x-show="yourBooksFilter === 'kobo'" class="bi bi-check-lg ml-auto"></i>
                        </button>
                        <button
                            @click="changeYourBooksFilter('requests')"
                            :class="yourBooksFilter === 'requests' ? 'bg-ink-900 text-white' : 'bg-ink-100 text-ink-700 hover:bg-ink-200'"
                            class="w-full px-4 py-3 text-sm font-medium rounded-lg transition-colors flex items-center gap-3"
                        >
                            <i class="bi bi-download text-base"></i>
                            <span>Requests</span>
                            <i x-show="yourBooksFilter === 'requests'" class="bi bi-check-lg ml-auto"></i>
                        </button>
                    </div>
                </div>

                <!-- Sort Section -->
                <div>
                    <h3 class="text-sm font-semibold text-ink-700 mb-3">Sort</h3>
                    <div class="space-y-2">
                        <button
                            @click="changeYourBooksSort('recent')"
                            :class="yourBooksSortBy === 'recent' ? 'bg-ink-900 text-white' : 'bg-ink-100 text-ink-700 hover:bg-ink-200'"
                            class="w-full px-4 py-3 text-sm font-medium rounded-lg transition-colors flex items-center gap-3"
                        >
                            <i class="bi bi-clock-history text-base"></i>
                            <span>Recently Added</span>
                            <i x-show="yourBooksSortBy === 'recent'" class="bi bi-check-lg ml-auto"></i>
                        </button>
                        <button
                            @click="changeYourBooksSort('author')"
                            :class="yourBooksSortBy === 'author' ? 'bg-ink-900 text-white' : 'bg-ink-100 text-ink-700 hover:bg-ink-200'"
                            class="w-full px-4 py-3 text-sm font-medium rounded-lg transition-colors flex items-center gap-3"
                        >
                            <i class="bi bi-person text-base"></i>
                            <span>Author (Last Name)</span>
                            <i x-show="yourBooksSortBy === 'author'" class="bi bi-check-lg ml-auto"></i>
                        </button>
                        <button
                            @click="changeYourBooksSort('title')"
                            :class="yourBooksSortBy === 'title' ? 'bg-ink-900 text-white' : 'bg-ink-100 text-ink-700 hover:bg-ink-200'"
                            class="w-full px-4 py-3 text-sm font-medium rounded-lg transition-colors flex items-center gap-3"
                        >
                            <i class="bi bi-type text-base"></i>
                            <span>Title (A-Z)</span>
                            <i x-show="yourBooksSortBy === 'title'" class="bi bi-check-lg ml-auto"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div x-show="showSettings" x-cloak @click.self="showSettings = false" 
         class="fixed inset-0 z-[60] modal-overlay flex items-center justify-center p-4">
        <div x-show="showSettings" x-transition class="bg-ink-100 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden">
            <div class="p-5 border-b border-ink-100 flex items-center justify-between">
                <h2 class="font-display text-lg font-bold text-ink-900">Settings</h2>
                <button @click="showSettings = false" class="p-3 hover:bg-ink-100 rounded-lg transition-colors flex items-center justify-center min-h-[44px] min-w-[44px]">
                    <i class="bi bi-x-lg text-ink-500"></i>
                </button>
                                </div>

            <div class="p-5 space-y-5 max-h-[60vh] overflow-y-auto">
                <!-- Hardcover API -->
                <div>
                    <label class="block text-sm font-semibold text-ink-700 mb-2">Hardcover API Key</label>
                    <div class="space-y-2">
                        <div class="flex items-center gap-2 p-3 bg-ink-50 rounded-xl">
                            <i class="bi bi-key text-ink-400"></i>
                            <input type="password" 
                                   x-model="hardcoverApiKeyInput"
                                   placeholder="Enter your Hardcover API key"
                                   class="flex-1 bg-transparent border-none outline-none text-sm text-ink-700 placeholder-ink-400">
                            <span x-show="hardcoverToken" class="w-2 h-2 bg-green-500 rounded-full"></span>
                        </div>
                        <button @click="validateHardcoverKey()" 
                                :disabled="validatingApiKey || !hardcoverApiKeyInput.trim()"
                                class="w-full px-4 py-2 bg-primary-600 text-white rounded-xl hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-sm font-semibold">
                            <span x-show="!validatingApiKey">Save Hardcover API Key</span>
                            <span x-show="validatingApiKey">Validating...</span>
                        </button>
                        <p x-show="apiKeyError" class="text-xs text-red-600" x-text="apiKeyError"></p>
                        <p x-show="apiKeySuccess" class="text-xs text-green-600">API key saved successfully!</p>
                    </div>
                </div>

                <!-- Calibre Library -->
                <div>
                    <label class="block text-sm font-semibold text-ink-700 mb-2">Calibre Library</label>
                    <div class="flex items-center gap-2 p-3 bg-ink-50 rounded-xl">
                        <i class="bi bi-database text-ink-400"></i>
                        <span class="text-sm text-ink-600 truncate flex-1" x-text="calibreLibraryPath || 'Not configured'"></span>
                        <span x-show="calibreLibraryPath" class="w-2 h-2 bg-green-500 rounded-full"></span>
                        <button @click="showSetup = true; setupStep = 2; showSettings = false; openBrowser()" 
                                class="text-primary-600 hover:text-primary-700 text-sm font-semibold">
                            <span x-text="calibreLibraryPath ? 'Change' : 'Configure'"></span>
                        </button>
                    </div>
                </div>

                <!-- Prowlarr (Optional) -->
                <div>
                    <label class="block text-sm font-semibold text-ink-700 mb-2">
                        Prowlarr
                        <span class="text-xs font-normal text-ink-400">(Optional)</span>
                    </label>
                    <div class="space-y-2">
                        <div class="flex items-center gap-2 p-3 bg-ink-50 rounded-xl">
                            <i class="bi bi-link-45deg text-ink-400"></i>
                            <input type="text" 
                                   x-model="prowlarrUrlInput"
                                   placeholder="Prowlarr URL (e.g., http://localhost:9696)"
                                   class="flex-1 bg-transparent border-none outline-none text-sm text-ink-700 placeholder-ink-400">
                        </div>
                        <div class="flex items-center gap-2 p-3 bg-ink-50 rounded-xl">
                            <i class="bi bi-key text-ink-400"></i>
                            <input type="password" 
                                   x-model="prowlarrApiKeyInput"
                                   placeholder="Prowlarr API Key"
                                   class="flex-1 bg-transparent border-none outline-none text-sm text-ink-700 placeholder-ink-400">
                            <span x-show="prowlarrUrl && prowlarrApiKey" class="w-2 h-2 bg-green-500 rounded-full"></span>
                        </div>
                        <button @click="validateProwlarr()" 
                                :disabled="validatingProwlarr || !prowlarrUrlInput.trim() || !prowlarrApiKeyInput.trim()"
                                class="w-full px-4 py-2 bg-primary-600 text-white rounded-xl hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-sm font-semibold">
                            <span x-show="!validatingProwlarr">Save Prowlarr Settings</span>
                            <span x-show="validatingProwlarr">Validating...</span>
                        </button>
                        <p x-show="prowlarrError" class="text-xs text-red-600" x-text="prowlarrError"></p>
                        <p x-show="prowlarrSuccess" class="text-xs text-green-600">Prowlarr configured successfully!</p>
                    </div>
                </div>

                <!-- Requests -->
                                <div>
                    <label class="block text-sm font-semibold text-ink-700 mb-2">
                        Book Requests 
                        <span class="text-ink-400 font-normal" x-text="`(${requestedBooks.length})`"></span>
                                    </label>
                    <div x-show="requestedBooks.length === 0" class="p-4 bg-ink-50 rounded-xl text-center text-ink-500 text-sm">
                        No pending requests
                                    </div>
                    <div x-show="requestedBooks.length > 0" class="space-y-2 max-h-40 overflow-y-auto">
                        <template x-for="book in requestedBooks" :key="book.id">
                            <div class="flex items-center gap-3 p-3 bg-ink-50 rounded-xl">
                                <img :src="book.image" class="w-8 h-12 rounded object-cover">
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-semibold text-ink-800 truncate" x-text="book.title"></p>
                                    <p class="text-xs text-ink-500 truncate" x-text="book.author"></p>
                                        </div>
                                <button @click="cancelRequest(book)" class="p-3 hover:bg-ink-200 rounded-lg transition-colors min-h-[44px] min-w-[44px] flex items-center justify-center">
                                    <i class="bi bi-x-lg text-ink-400"></i>
                                                </button>
                                            </div>
                                        </template>
                                    </div>
                                </div>

                <!-- About -->
                <div class="pt-4 border-t border-ink-100">
                    <p class="text-xs text-ink-400 text-center">
                        folio • Your Personal Library Manager<br>
                        Powered by <a href="https://hardcover.app" target="_blank" class="text-primary-600 hover:text-primary-700 hover:underline">Hardcover.app</a>
                    </p>
                            </div>
                        </div>
                </div>
            </div>

    <!-- Requests View (List format) -->
    <div x-show="showRequests" x-cloak class="fixed inset-0 z-50 bg-ink-50">
        <!-- Header -->
        <div class="sticky top-0 z-10 glass border-b border-ink-200 safe-area-top">
            <div class="flex items-center h-12 px-3">
                <button @click="closeRequests()" class="p-3 -ml-2 text-ink-600 hover:text-ink-800 transition-colors min-h-[44px] min-w-[44px] flex items-center justify-center">
                    <i class="bi bi-arrow-left text-lg"></i>
                </button>
                <h1 class="flex-1 text-center font-display text-base font-semibold text-ink-800 truncate px-4">Book Requests</h1>
                <div class="w-8"></div>
        </div>
    </div>

        <!-- Requests List -->
        <div class="p-3 pb-16 overflow-y-auto" style="height: calc(100vh - 48px);">
            <!-- Empty State -->
            <div x-show="requestedBooks.length === 0" class="py-12 text-center">
                <i class="bi bi-inbox text-4xl text-ink-300 mb-3"></i>
                <p class="text-ink-500 text-sm">No book requests yet</p>
                            </div>

            <!-- Requests List -->
            <div x-show="requestedBooks.length > 0" class="space-y-3">
                <template x-for="book in requestedBooks" :key="book.id">
                    <div class="flex items-center gap-3 p-3 bg-white border border-ink-200 rounded-xl hover:border-ink-300 transition-colors">
                        <!-- Cover -->
                        <img 
                            :src="book.image" 
                            :alt="book.title" 
                            class="w-16 h-24 object-cover rounded-lg flex-shrink-0"
                            @error="$el.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 150%22><rect fill=%22%23e5e7eb%22 width=%22100%22 height=%22150%22/><text x=%2250%22 y=%2275%22 text-anchor=%22middle%22 fill=%22%239ca3af%22 font-size=%2212%22>No Cover</text></svg>'"
                        >
                        
                        <!-- Details -->
                        <div class="flex-1 min-w-0">
                            <h3 class="text-sm font-semibold text-ink-900 line-clamp-2 mb-1" x-text="book.title"></h3>
                            <p class="text-xs text-ink-600 mb-1" x-text="book.author || 'Unknown Author'"></p>
                            <p class="text-xs text-ink-400" x-text="formatRequestDate(book.requested_at)"></p>
                                        </div>
                        
                        <!-- Search Button -->
                        <button 
                            @click="searchProwlarr(book)"
                            :disabled="!prowlarrUrl || !prowlarrApiKey"
                            class="px-4 py-2 bg-coral-500 hover:bg-coral-600 disabled:bg-ink-200 disabled:text-ink-400 text-white text-sm font-medium rounded-lg transition-colors flex items-center gap-2 flex-shrink-0"
                            title="Search in Prowlarr"
                        >
                            <i class="bi bi-search"></i>
                            <span class="hidden sm:inline">Search</span>
                                        </button>
                                    </div>
                                </template>
            </div>
        </div>
    </div>

    <!-- Bookshelf View (Full page grid of books) -->
    <div x-show="showBookshelf" x-cloak class="fixed inset-0 z-50 bg-white">
        <!-- Header -->
        <div class="sticky top-0 z-10 glass border-b border-ink-200 safe-area-top">
            <div class="flex items-center h-12 px-3">
                <button @click="closeBookshelf()" class="p-3 -ml-2 text-ink-600 hover:text-ink-800 transition-colors min-h-[44px] min-w-[44px] flex items-center justify-center">
                    <i class="bi bi-arrow-left text-lg"></i>
                </button>
                <h1 class="flex-1 text-center font-display text-base font-semibold text-ink-800 truncate px-4" x-text="bookshelfTitle"></h1>
                <div class="w-8"></div>
                                </div>
                            </div>

        <!-- View Toggle -->
        <div class="sticky top-12 z-10 bg-white border-b border-ink-200 px-3 py-2">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-1 bg-ink-100 rounded-lg p-1">
                    <button 
                        @click="bookshelfView = 'list'; currentListPage = 1"
                        :class="bookshelfView === 'list' ? 'bg-white text-ink-900 shadow-sm' : 'text-ink-500'"
                        class="p-3 rounded transition-colors min-h-[44px] min-w-[44px] flex items-center justify-center"
                        title="List View"
                    >
                        <i class="bi bi-list"></i>
                    </button>
                    <button 
                        @click="bookshelfView = 'grid'; currentListPage = 1"
                        :class="bookshelfView === 'grid' ? 'bg-white text-ink-900 shadow-sm' : 'text-ink-500'"
                        class="p-3 rounded transition-colors min-h-[44px] min-w-[44px] flex items-center justify-center"
                        title="Grid View"
                    >
                        <i class="bi bi-grid-3x3-gap"></i>
                                </button>
                            </div>
                        </div>
                    </div>

        <!-- List View -->
        <div x-show="bookshelfView === 'list'" class="p-3 pb-16 overflow-y-auto" style="height: calc(100vh - 96px);">
            <!-- Pagination Controls -->
            <div class="flex items-center justify-between mb-4 gap-2">
                <div class="flex items-center gap-2">
                    <label class="text-sm text-ink-600">Books per page:</label>
                    <select x-model.number="booksPerPage" @change="currentListPage = 1" class="px-3 py-1.5 border border-ink-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-ocean-500">
                        <option :value="10">10</option>
                        <option :value="20">20</option>
                        <option :value="50">50</option>
                        <option :value="100">100</option>
                    </select>
                </div>
                <div class="flex items-center gap-2 text-sm text-ink-600">
                    <span x-text="`Page ${currentListPage} of ${totalBookshelfPages()}`"></span>
                    <button @click="prevListPage()" :disabled="currentListPage === 1" 
                            :class="currentListPage === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-ink-50'"
                            class="p-3 rounded-lg transition-colors min-h-[44px] min-w-[44px] flex items-center justify-center">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <button @click="nextListPage()" :disabled="currentListPage === totalBookshelfPages()" 
                            :class="currentListPage === totalBookshelfPages() ? 'opacity-50 cursor-not-allowed' : 'hover:bg-ink-50'"
                            class="p-3 rounded-lg transition-colors min-h-[44px] min-w-[44px] flex items-center justify-center">
                        <i class="bi bi-chevron-right"></i>
                    </button>
            </div>
        </div>

            <div class="space-y-3">
                <template x-for="book in paginatedBookshelfBooks()" :key="book.id">
                    <div class="flex items-center gap-3 p-3 bg-white border border-ink-200 rounded-xl hover:border-ink-300 transition-colors">
                        <!-- Cover -->
                        <img 
                            @click="book.authors ? openBookModal(book) : openHardcoverModal(book)"
                            :src="book.authors ? `/api/cover/${book.id}?v=${coverVersion}` : book.image" 
                            :alt="book.title" 
                            class="w-16 h-24 object-cover rounded-lg flex-shrink-0 cursor-pointer"
                            @error="$el.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 150%22><rect fill=%22%23e5e7eb%22 width=%22100%22 height=%22150%22/><text x=%2250%22 y=%2275%22 text-anchor=%22middle%22 fill=%22%239ca3af%22 font-size=%2212%22>No Cover</text></svg>'"
                        >
                        
                        <!-- Details -->
                        <div @click="book.authors ? openBookModal(book) : openHardcoverModal(book)" class="flex-1 min-w-0 cursor-pointer">
                            <h3 class="text-sm font-semibold text-ink-900 line-clamp-2 mb-1" x-text="book.title"></h3>
                            <p class="text-xs text-ink-600 mb-1" x-text="book.authors ? formatAuthors(book.authors) : (book.author || 'Unknown Author')"></p>
                            <span x-show="book.inLibrary" class="inline-block mt-1 px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs">
                                <i class="bi bi-check-lg"></i> In Library
                            </span>
                            </div>
                        </div>
                </template>
                            </div>
                                </div>

        <!-- Grid View -->
        <div x-show="bookshelfView === 'grid'" class="p-3 pb-16 overflow-y-auto" style="height: calc(100vh - 96px);">
            <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-3">
                <template x-for="book in bookshelfBooks" :key="book.id">
                    <div @click="book.authors ? openBookModal(book) : openHardcoverModal(book)" class="book-card cursor-pointer">
                        <div class="book-cover relative">
                            <img 
                                :src="book.authors ? `/api/cover/${book.id}?v=${coverVersion}` : book.image" 
                                :alt="book.title" 
                                loading="lazy" 
                                class="w-full h-full object-cover"
                                @error="$el.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 150%22><rect fill=%22%23e5e7eb%22 width=%22100%22 height=%22150%22/><text x=%2250%22 y=%2275%22 text-anchor=%22middle%22 fill=%22%239ca3af%22 font-size=%2212%22>No Cover</text></svg>'"
                            >
                            <span x-show="book.inLibrary" class="absolute top-1 right-1 bg-green-500 text-white text-xs px-1.5 py-0.5 rounded-full">
                                <i class="bi bi-check-lg"></i>
                            </span>
                                        </div>
                        <h3 class="mt-1.5 text-xs font-semibold text-ink-800 line-clamp-2 leading-tight" x-text="book.title"></h3>
                        <p class="text-xs text-ink-500 line-clamp-1" x-text="book.authors ? formatAuthors(book.authors) : (book.author || 'Unknown Author')"></p>
                                    </div>
                </template>
                                </div>

            <!-- Empty State -->
            <div x-show="bookshelfBooks.length === 0" class="py-12 text-center">
                <div class="spinner w-6 h-6 mx-auto"></div>
                <p class="text-ink-500 text-sm mt-3">Loading books...</p>
                                        </div>
                                    </div>
                                </div>

    <!-- Card Catalog Modal -->
    <div x-show="showCardCatalog" x-cloak @click.self="showCardCatalog = false"
         class="fixed inset-0 z-[70] modal-overlay flex items-center justify-center p-4">
        <div x-show="showCardCatalog" x-transition
             @keydown.escape.window="showCardCatalog = false"
             class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-visible relative">
            <!-- Close Button -->
            <button
                @click="showCardCatalog = false"
                class="absolute top-4 right-4 z-10 p-2 bg-white rounded-full shadow-lg hover:bg-ink-50 transition-colors"
                title="Close"
            >
                <i class="bi bi-x-lg text-ink-600"></i>
            </button>

            <!-- Loading State -->
            <div x-show="loadingCardCatalog" class="py-24 px-4 text-center">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-ink-100 rounded-full mb-4">
                    <div class="spinner w-6 h-6"></div>
                </div>
                <h3 class="text-lg font-semibold text-ink-700">Loading books...</h3>
            </div>

            <!-- Swipeable Cards Stack -->
            <div x-show="!loadingCardCatalog && cardCatalogBooks.length > 0" class="relative h-[600px] p-6">
                <!-- Card Counter -->
                <div class="absolute top-2 left-1/2 transform -translate-x-1/2 z-20 bg-white px-4 py-1 rounded-full shadow-md">
                    <span class="text-sm font-semibold text-ink-700" x-text="`${currentCardIndex + 1} / ${cardCatalogBooks.length}`"></span>
                </div>

                <!-- Cards Stack (show current and next 2 cards) -->
                <div class="relative w-full h-full">
                    <template x-for="(book, index) in cardCatalogBooks.slice(currentCardIndex, currentCardIndex + 3)" :key="book.id">
                        <div
                            :class="{
                                'z-30': index === 0,
                                'z-20': index === 1,
                                'z-10': index === 2
                            }"
                            :style="{
                                transform: index === 0 ? 'scale(1) translateY(0)' :
                                          index === 1 ? 'scale(0.95) translateY(10px)' :
                                          'scale(0.9) translateY(20px)',
                                opacity: index === 0 ? '1' : index === 1 ? '0.7' : '0.4'
                            }"
                            class="swipe-card absolute inset-0 bg-white rounded-2xl shadow-2xl overflow-hidden transition-all duration-300"
                            x-data="{
                                isDragging: false,
                                startX: 0,
                                startY: 0,
                                currentX: 0,
                                currentY: 0,
                                offsetX: 0,
                                offsetY: 0
                            }"
                            @mousedown="if (index === 0) { isDragging = true; startX = $event.clientX; startY = $event.clientY; }"
                            @touchstart="if (index === 0) { isDragging = true; startX = $event.touches[0].clientX; startY = $event.touches[0].clientY; }"
                            @mousemove.window="if (isDragging && index === 0) {
                                currentX = $event.clientX;
                                currentY = $event.clientY;
                                offsetX = currentX - startX;
                                offsetY = currentY - startY;
                                $el.style.transform = `translate(${offsetX}px, ${offsetY}px) rotate(${offsetX * 0.1}deg)`;
                            }"
                            @touchmove.window="if (isDragging && index === 0) {
                                currentX = $event.touches[0].clientX;
                                currentY = $event.touches[0].clientY;
                                offsetX = currentX - startX;
                                offsetY = currentY - startY;
                                $el.style.transform = `translate(${offsetX}px, ${offsetY}px) rotate(${offsetX * 0.1}deg)`;
                            }"
                            @mouseup.window="if (isDragging && index === 0) {
                                isDragging = false;
                                if (Math.abs(offsetX) > 100) {
                                    // Swipe detected
                                    if (offsetX > 0) {
                                        // Swipe right - Add to requests
                                        $el.style.transform = `translate(${window.innerWidth}px, ${offsetY}px) rotate(30deg)`;
                                        setTimeout(() => { addCardToRequests(book); }, 300);
                                    } else {
                                        // Swipe left - Dismiss
                                        $el.style.transform = `translate(-${window.innerWidth}px, ${offsetY}px) rotate(-30deg)`;
                                        setTimeout(() => { dismissCard(); }, 300);
                                    }
                                } else {
                                    // Snap back
                                    $el.style.transform = 'translate(0, 0) rotate(0deg)';
                                }
                                offsetX = 0;
                                offsetY = 0;
                            }"
                            @touchend.window="if (isDragging && index === 0) {
                                isDragging = false;
                                if (Math.abs(offsetX) > 100) {
                                    // Swipe detected
                                    if (offsetX > 0) {
                                        // Swipe right - Add to requests
                                        $el.style.transform = `translate(${window.innerWidth}px, ${offsetY}px) rotate(30deg)`;
                                        setTimeout(() => { addCardToRequests(book); }, 300);
                                    } else {
                                        // Swipe left - Dismiss
                                        $el.style.transform = `translate(-${window.innerWidth}px, ${offsetY}px) rotate(-30deg)`;
                                        setTimeout(() => { dismissCard(); }, 300);
                                    }
                                } else {
                                    // Snap back
                                    $el.style.transform = 'translate(0, 0) rotate(0deg)';
                                }
                                offsetX = 0;
                                offsetY = 0;
                            }"
                        >
                            <!-- Swipe Indicators -->
                            <div
                                x-show="index === 0 && offsetX > 50"
                                class="absolute inset-0 bg-green-500 bg-opacity-20 flex items-center justify-center pointer-events-none z-20"
                            >
                                <div class="bg-green-500 text-white px-6 py-3 rounded-xl font-bold text-2xl shadow-lg transform rotate-12">
                                    <i class="bi bi-heart-fill"></i>
                                </div>
                            </div>
                            <div
                                x-show="index === 0 && offsetX < -50"
                                class="absolute inset-0 bg-red-500 bg-opacity-20 flex items-center justify-center pointer-events-none z-20"
                            >
                                <div class="bg-red-500 text-white px-6 py-3 rounded-xl font-bold text-2xl shadow-lg transform -rotate-12">
                                    <i class="bi bi-x-lg"></i>
                                </div>
                            </div>

                            <!-- Card Content -->
                            <div class="flex flex-col h-full p-6 pointer-events-none">
                                <!-- Book Cover -->
                                <div class="flex-1 flex items-center justify-center mb-4">
                                    <img :src="book.image" :alt="book.title"
                                         class="max-w-full max-h-[350px] object-contain rounded-lg shadow-lg"
                                         @error="$el.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 150%22><rect fill=%22%23e5e7eb%22 width=%22100%22 height=%22150%22/><text x=%2250%22 y=%2275%22 text-anchor=%22middle%22 fill=%22%239ca3af%22 font-size=%2212%22>No Cover</text></svg>'">
                                </div>

                                <!-- Book Details -->
                                <div class="text-center">
                                    <h2 class="text-xl font-display font-bold text-ink-900 mb-1 line-clamp-2" x-text="book.title"></h2>
                                    <p class="text-ink-600 line-clamp-1" x-text="book.author"></p>
                                    <p class="text-ink-400 text-sm mt-1" x-show="book.year" x-text="book.year"></p>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Action Buttons -->
                <div class="absolute bottom-6 left-0 right-0 px-6 z-40 flex justify-center gap-4 pointer-events-none">
                    <button
                        @click="if (cardCatalogBooks.length > currentCardIndex) {
                            const el = $el.closest('.relative').querySelector('.swipe-card');
                            el.style.transform = `translate(-${window.innerWidth}px, 0) rotate(-30deg)`;
                            setTimeout(() => { dismissCard(); }, 300);
                        }"
                        class="w-16 h-16 bg-white border-4 border-red-500 rounded-full flex items-center justify-center shadow-xl hover:bg-red-50 transition-colors pointer-events-auto"
                        title="Dismiss"
                    >
                        <i class="bi bi-x-lg text-red-500 text-2xl"></i>
                    </button>
                    <button
                        @click="if (cardCatalogBooks.length > currentCardIndex) { openHardcoverModal(cardCatalogBooks[currentCardIndex]); }"
                        class="w-16 h-16 bg-white border-4 border-blue-500 rounded-full flex items-center justify-center shadow-xl hover:bg-blue-50 transition-colors pointer-events-auto"
                        title="View Details"
                    >
                        <i class="bi bi-info-lg text-blue-500 text-2xl"></i>
                    </button>
                    <button
                        @click="if (cardCatalogBooks.length > currentCardIndex) {
                            const el = $el.closest('.relative').querySelector('.swipe-card');
                            el.style.transform = `translate(${window.innerWidth}px, 0) rotate(30deg)`;
                            setTimeout(() => { addCardToRequests(cardCatalogBooks[currentCardIndex]); }, 300);
                        }"
                        class="w-16 h-16 bg-white border-4 border-green-500 rounded-full flex items-center justify-center shadow-xl hover:bg-green-50 transition-colors pointer-events-auto"
                        title="Add to Requests"
                    >
                        <i class="bi bi-heart-fill text-green-500 text-2xl"></i>
                    </button>
                </div>
            </div>

            <!-- Empty State -->
            <div x-show="!loadingCardCatalog && cardCatalogBooks.length === 0" class="py-12 px-4 text-center">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-ink-100 rounded-full mb-4">
                    <i class="bi bi-inbox text-2xl text-ink-400"></i>
                </div>
                <h3 class="text-lg font-semibold text-ink-700 mb-2">No books available</h3>
                <p class="text-ink-500 text-sm">Check back later for new recommendations</p>
            </div>

            <!-- All done message -->
            <div x-show="!loadingCardCatalog && cardCatalogBooks.length > 0 && currentCardIndex >= cardCatalogBooks.length"
                 class="py-12 px-4 text-center">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4">
                    <i class="bi bi-check-circle text-2xl text-green-600"></i>
                </div>
                <h3 class="text-lg font-semibold text-ink-700 mb-2">All done!</h3>
                <p class="text-ink-500 text-sm mb-4">You've reviewed all the books</p>
                <button @click="showCardCatalog = false" class="btn btn-primary">Close</button>
            </div>
        </div>
    </div>

        <!-- Back to top button -->
        <button
            x-show="showBackToTop"
            @click="window.scrollTo({ top: 0, behavior: 'smooth' })"
            x-cloak
            class="fixed bottom-20 right-4 z-50 px-4 py-2 rounded-full shadow-lg bg-primary-600 text-white hover:bg-primary-500 transition flex items-center gap-2"
        >
            <i class="bi bi-arrow-up"></i>
            <span>Back to top</span>
        </button>

    <!-- Prowlarr Search Modal -->
    <div x-show="selectedRequestBook" x-cloak @click.self="selectedRequestBook = null; prowlarrSearchResults = []; downloadingProwlarr = null; downloadProwlarrSuccess = null; downloadProwlarrError = null;" 
         class="fixed inset-0 z-[60] modal-overlay flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div x-show="selectedRequestBook" x-transition:enter="slide-up" 
             class="bg-ink-100 w-full sm:max-w-[720px] sm:rounded-2xl rounded-t-[20px] max-h-[90vh] flex flex-col shadow-2xl border border-ink-200">
            
            <!-- Sticky Header -->
            <div class="flex justify-between items-center p-4 border-b border-ink-100 sticky top-0 bg-white z-10 rounded-t-[20px] sm:rounded-t-2xl">
                <div>
                    <h2 class="text-lg font-semibold text-ink-900">Prowlarr Search Results</h2>
                    <p class="text-sm text-ink-500" x-text="selectedRequestBook?.title"></p>
                                </div>
                <button @click="selectedRequestBook = null; prowlarrSearchResults = []; downloadingProwlarr = null; downloadProwlarrSuccess = null; downloadProwlarrError = null;" class="p-3 hover:bg-ink-50 rounded-lg transition-colors min-h-[44px] min-w-[44px] flex items-center justify-center">
                    <i class="bi bi-x-lg text-ink-600"></i>
                </button>
                            </div>

            <!-- Scrollable Body -->
            <div class="flex-1 overflow-y-auto p-4">
                <!-- Loading State -->
                <div x-show="searchingProwlarr" class="py-8 text-center">
                    <div class="spinner w-6 h-6 mx-auto"></div>
                    <p class="text-ink-500 text-sm mt-3">Searching Prowlarr...</p>
                        </div>

                <!-- Error State -->
                <div x-show="prowlarrError && !searchingProwlarr" class="p-4 bg-red-50 border border-red-200 rounded-xl mb-4">
                    <p class="text-sm text-red-700" x-text="prowlarrError"></p>
                </div>

                <!-- Download Error State -->
                <div x-show="downloadProwlarrError" class="p-4 bg-red-50 border border-red-200 rounded-xl mb-4">
                    <p class="text-sm text-red-700" x-text="downloadProwlarrError"></p>
                </div>

                <!-- Download Success State -->
                <div x-show="downloadProwlarrSuccess !== null" class="p-4 bg-green-50 border border-green-200 rounded-xl mb-4">
                    <p class="text-sm text-green-700">✓ Download sent to bittorrent client successfully!</p>
                </div>

                <!-- No Results -->
                <div x-show="!searchingProwlarr && !prowlarrError && prowlarrSearchResults.length === 0" class="py-8 text-center">
                    <i class="bi bi-search text-3xl text-ink-300 mb-3"></i>
                    <p class="text-ink-500 text-sm">No results found</p>
                            </div>

                <!-- Results List -->
                <div x-show="!searchingProwlarr && prowlarrSearchResults.length > 0" class="space-y-3">
                    <!-- Sort Controls -->
                    <div class="flex items-center gap-2 mb-3 pb-3 border-b border-ink-200">
                        <span class="text-xs text-ink-500 font-medium">Sort by:</span>
                        <button 
                            @click="changeProwlarrSort('seeders')"
                            :class="prowlarrSortBy === 'seeders' ? 'bg-ink-900 text-white' : 'bg-ink-100 text-ink-700 hover:bg-ink-200'"
                            class="px-3 py-1.5 text-xs font-medium rounded-lg transition-colors flex items-center gap-1"
                        >
                            <span>Seeders</span>
                            <i x-show="prowlarrSortBy === 'seeders'" :class="prowlarrSortOrder === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'" class="bi text-xs"></i>
                        </button>
                        <button 
                            @click="changeProwlarrSort('size')"
                            :class="prowlarrSortBy === 'size' ? 'bg-ink-900 text-white' : 'bg-ink-100 text-ink-700 hover:bg-ink-200'"
                            class="px-3 py-1.5 text-xs font-medium rounded-lg transition-colors flex items-center gap-1"
                        >
                            <span>Size</span>
                            <i x-show="prowlarrSortBy === 'size'" :class="prowlarrSortOrder === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'" class="bi text-xs"></i>
                        </button>
                        <button 
                            @click="changeProwlarrSort('title')"
                            :class="prowlarrSortBy === 'title' ? 'bg-ink-900 text-white' : 'bg-ink-100 text-ink-700 hover:bg-ink-200'"
                            class="px-3 py-1.5 text-xs font-medium rounded-lg transition-colors flex items-center gap-1"
                        >
                            <span>Title</span>
                            <i x-show="prowlarrSortBy === 'title'" :class="prowlarrSortOrder === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'" class="bi text-xs"></i>
                                        </button>
                                    </div>
                    
                    <template x-for="(result, index) in prowlarrSearchResults" :key="index">
                        <div class="p-3 border border-ink-200 rounded-xl hover:border-ink-300 transition-colors" :class="{'bg-green-50 border-green-200': downloadProwlarrSuccess === index}">
                            <div class="flex items-start gap-3">
                                <div class="flex-1 min-w-0">
                                    <h3 class="text-sm font-medium text-ink-900 mb-1.5 leading-relaxed" x-text="result.title"></h3>
                                    <p class="text-xs text-ink-500 mb-2" x-text="result.indexer"></p>
                                    <div class="flex items-center gap-2.5 text-xs text-ink-600 flex-wrap">
                                        <span x-show="result.size" class="flex items-center gap-1 whitespace-nowrap">
                                            <i class="bi bi-file-earmark text-ink-400"></i>
                                            <span x-text="formatFileSize(result.size)"></span>
                                        </span>
                                        <span class="flex items-center gap-1 whitespace-nowrap">
                                            <i class="bi bi-arrow-up-circle text-green-500"></i>
                                            <span x-text="result.seeders || 0"></span>
                                        </span>
                                        <span x-show="result.leechers !== undefined" class="flex items-center gap-1 whitespace-nowrap">
                                            <i class="bi bi-arrow-down-circle text-ink-400"></i>
                                            <span x-text="result.leechers"></span>
                                        </span>
                                    </div>
                                    <!-- Success indicator -->
                                    <div x-show="downloadProwlarrSuccess === index" class="mt-2 text-xs text-green-600 flex items-center gap-1">
                                        <i class="bi bi-check-circle"></i>
                                        <span>Download sent!</span>
                                    </div>
                                </div>
                                <button 
                                    @click="downloadFromProwlarr(result, selectedRequestBook)"
                                    :disabled="downloadingProwlarr === index || downloadProwlarrSuccess === index"
                                    class="p-2.5 bg-sage-500 hover:bg-sage-600 disabled:bg-sage-300 disabled:cursor-not-allowed text-white rounded-lg transition-colors flex-shrink-0 self-start min-w-[44px] min-h-[44px] flex items-center justify-center"
                                    :title="downloadProwlarrSuccess === index ? 'Download sent' : 'Send to bittorrent client'"
                                >
                                    <span x-show="downloadingProwlarr !== index && downloadProwlarrSuccess !== index">
                                        <i class="bi bi-download text-base"></i>
                                    </span>
                                    <span x-show="downloadingProwlarr === index" class="spinner w-5 h-5"></span>
                                    <span x-show="downloadProwlarrSuccess === index">
                                        <i class="bi bi-check-lg text-base"></i>
                                    </span>
                                </button>
                            </div>
                        </div>
                    </template>
                    </div>
                </div>
            </div>
        </div>

    <!-- Camera Capture Modal -->
    <div x-show="showCameraCapture" x-cloak @click.self="closeCameraCapture()"
         class="fixed inset-0 z-[70] bg-black/90 flex items-center justify-center">
        <!-- Camera View -->
        <div class="relative w-full h-full max-w-lg max-h-[80vh] flex flex-col">
            <!-- Header -->
            <div class="flex justify-between items-center p-4 text-white">
                <h2 class="text-lg font-semibold">Scan Book Cover</h2>
                <button @click="closeCameraCapture()" class="p-2 hover:bg-white/10 rounded-lg transition-colors">
                    <i class="bi bi-x-lg text-xl"></i>
                </button>
            </div>

            <!-- Video preview / Captured image / Loading state -->
            <div class="flex-1 flex items-center justify-center overflow-hidden px-4">
                <!-- Camera initializing -->
                <div x-show="cameraState === 'initializing'" class="text-center text-white">
                    <div class="spinner w-8 h-8 mx-auto mb-3"></div>
                    <p class="text-sm">Starting camera...</p>
                </div>

                <!-- Camera error -->
                <div x-show="cameraState === 'error'" class="text-center text-white px-4">
                    <i class="bi bi-exclamation-triangle text-4xl text-amber-400 mb-3"></i>
                    <p class="text-base mb-2">Camera unavailable</p>
                    <p class="text-sm text-white/70" x-text="cameraError"></p>
                    <button @click="closeCameraCapture()" class="mt-4 px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg text-sm transition-colors">
                        Close
                    </button>
                </div>

                <!-- Live camera feed -->
                <div x-show="cameraState === 'ready'" class="relative w-full">
                    <video x-ref="cameraVideo" autoplay playsinline muted class="w-full rounded-lg"></video>
                    <!-- Viewfinder overlay -->
                    <div class="absolute inset-0 pointer-events-none">
                        <div class="absolute inset-4 border-2 border-white/50 rounded-lg"></div>
                    </div>
                </div>

                <!-- Captured image preview -->
                <div x-show="cameraState === 'captured' || cameraState === 'identifying'" class="relative w-full">
                    <img x-ref="capturedImage" class="w-full rounded-lg" :src="capturedImageSrc">
                    <!-- Loading overlay when identifying -->
                    <div x-show="cameraState === 'identifying'" class="absolute inset-0 bg-black/50 flex items-center justify-center rounded-lg">
                        <div class="text-center text-white">
                            <div class="spinner w-8 h-8 mx-auto mb-3"></div>
                            <p class="text-sm">Identifying book...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="p-4 flex justify-center gap-4">
                <!-- Capture button (when camera is ready) -->
                <button x-show="cameraState === 'ready'" @click="capturePhoto()"
                        class="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-lg hover:bg-gray-100 transition-colors">
                    <div class="w-12 h-12 bg-white rounded-full border-4 border-ink-900"></div>
                </button>

                <!-- Retake / Confirm buttons (after capture) -->
                <template x-if="cameraState === 'captured'">
                    <div class="flex gap-4">
                        <button @click="retakePhoto()"
                                class="px-6 py-3 bg-white/20 hover:bg-white/30 text-white rounded-lg transition-colors flex items-center gap-2">
                            <i class="bi bi-arrow-counterclockwise"></i>
                            <span>Retake</span>
                        </button>
                        <button @click="identifyBook()"
                                class="px-6 py-3 bg-ocean-500 hover:bg-ocean-600 text-white rounded-lg transition-colors flex items-center gap-2">
                            <i class="bi bi-search"></i>
                            <span>Search</span>
                        </button>
                    </div>
                </template>
            </div>
        </div>

        <!-- Hidden canvas for capturing frames -->
        <canvas x-ref="cameraCanvas" class="hidden"></canvas>
    </div>

    <!-- App Script -->
    <script src="/js/app.js"></script>
</body>
</html>
